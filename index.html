<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Orçamentário SUAD</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Lodash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <!-- Tabulator para tabelas avançadas -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.4.4/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.4.4/js/tabulator.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-title {
            background: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: none;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f1f5f9;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
        }
        .small-card {
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .small-card .card-body {
            padding: 10px 15px;
            text-align: center;
        }
        .value-card {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .neutral {
            color: #6c757d;
        }
        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .btn-upload {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-upload:hover {
            background-color: #0056b3;
        }
        .tabulator {
            font-size: 14px;
            border: none;
            border-radius: 10px;
            overflow: hidden;
        }
        .tabulator-header {
            background-color: #f1f5f9;
            border-bottom: 2px solid #e3e6f0;
        }
        .tabulator-row {
            border-bottom: 1px solid #f1f5f9;
        }
        .tabulator-row:hover {
            background-color: #f8f9fa !important;
        }
        .tabulator-row.tabulator-row-even {
            background-color: #ffffff;
        }
        .tabulator-row.tabulator-row-odd {
            background-color: #fcfcfd;
        }
        .progress-container {
            width: 100%;
            background-color: #f1f5f9;
            border-radius: 20px;
            margin-bottom: 10px;
            height: 25px;
        }
        .progress-bar {
            height: 100%;
            border-radius: 20px;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: 600;
            transition: width 1s ease-in-out;
        }
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            background-color: transparent;
            border-bottom: 3px solid #007bff;
        }
        .form-select, .form-control {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 8px 12px;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid py-3">
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-title d-flex justify-content-between align-items-center">
                    <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i>Dashboard Orçamentário SUAD</h1>
                    <button id="btnImportExcel" class="btn btn-light"><i class="fas fa-file-excel me-2"></i>Importar Planilha</button>
                </div>
            </div>
        </div>

        <!-- Filtros Globais -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="filtroAno" class="form-label">Ano de Repasse</label>
                            <select id="filtroAno" class="form-select">
                                <option value="todos">Todos os Anos</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filtroAcao" class="form-label">Ação</label>
                            <select id="filtroAcao" class="form-select">
                                <option value="todos">Todas as Ações</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filtroNatureza" class="form-label">Natureza da Despesa</label>
                            <select id="filtroNatureza" class="form-select">
                                <option value="todos">Todas as Naturezas</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filtroFundo" class="form-label">Fundo</label>
                            <select id="filtroFundo" class="form-select">
                                <option value="todos">Todos os Fundos</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card small-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Planejado</h5>
                        <p class="value-card" id="totalPlanejado">R$ 0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card small-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Executado</h5>
                        <p class="value-card" id="totalExecutado">R$ 0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card small-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted">% de Execução</h5>
                        <p class="value-card" id="percentualExecucao">0%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card small-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Saldo a Executar</h5>
                        <p class="value-card" id="saldoExecutar">R$ 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progresso de Execução por Ação -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Progresso de Execução por Ação</h5>
                    </div>
                    <div class="card-body">
                        <div id="progressoAcoes"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Abas para diferentes visualizações -->
        <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos" type="button" role="tab" aria-controls="graficos" aria-selected="true">
                    <i class="fas fa-chart-pie me-2"></i>Gráficos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tabelas-tab" data-bs-toggle="tab" data-bs-target="#tabelas" type="button" role="tab" aria-controls="tabelas" aria-selected="false">
                    <i class="fas fa-table me-2"></i>Tabelas Detalhadas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analise-tab" data-bs-toggle="tab" data-bs-target="#analise" type="button" role="tab" aria-controls="analise" aria-selected="false">
                    <i class="fas fa-search-dollar me-2"></i>Análise Financeira
                </button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabsContent">
            <!-- Aba de Gráficos -->
            <div class="tab-pane fade show active" id="graficos" role="tabpanel" aria-labelledby="graficos-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Comparativo Planejado x Executado por Ano</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="comparativoAnoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Distribuição por Natureza de Despesa</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="naturezaDespesaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Execução Mensal</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="execucaoMensalChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Distribuição por Item Macro</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="itensMacroChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Tabelas Detalhadas -->
            <div class="tab-pane fade" id="tabelas" role="tabpanel" aria-labelledby="tabelas-tab">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Detalhamento de Execução</h5>
                                <div class="btn-group" role="group">
                                    <button id="btnExportarExecucao" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file-export me-1"></i>Exportar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="tabelaExecutado" class="tabulator-full"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Detalhamento de Planejamento</h5>
                                <div class="btn-group" role="group">
                                    <button id="btnExportarPlanejamento" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file-export me-1"></i>Exportar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="tabelaPlanejado" class="tabulator-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Análise Financeira -->
            <div class="tab-pane fade" id="analise" role="tabpanel" aria-labelledby="analise-tab">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Síntese da Execução Orçamentária</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <canvas id="eficienciaChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="analiseFinanceira"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Comparativo entre Ações</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="comparativoAcoesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Tendência de Execução</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="tendenciaExecucaoChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variáveis globais para armazenar os dados
        let dadosExecutado = [];
        let dadosPlanejado = [];
        let tabelaExecutado, tabelaPlanejado;
        let charts = {};
        let filtrosAplicados = {
            ano: 'todos',
            acao: 'todos',
            natureza: 'todos',
            fundo: 'todos'
        };

        // Cores para os gráficos
        const coresPrimarias = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
            '#6f42c1', '#5a5c69', '#2c9faf', '#85BB65', '#e83e8c'
        ];
        
        // Função para formatar valores monetários
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(valor);
        }

        // Função para formatar datas
        function formatarData(data) {
            if (!data) return '-';
            try {
                return new Date(data).toLocaleDateString('pt-BR');
            } catch (e) {
                return '-';
            }
        }

        // Função para carregar os dados da planilha
        async function carregarPlanilha(arquivo) {
            try {
                document.getElementById('loader').style.display = 'flex';
                const arrayBuffer = await arquivo.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { 
                    type: 'array',
                    cellDates: true,
                    cellStyles: true
                });
                
                // Resetar os dados existentes
                dadosExecutado = [];
                dadosPlanejado = [];
                
                // Processando as abas
                if (workbook.SheetNames.includes('EXECUTADO_TOTAL')) {
                    const sheet = workbook.Sheets['EXECUTADO_TOTAL'];
                    dadosExecutado = XLSX.utils.sheet_to_json(sheet);
                    console.log(`Dados da aba EXECUTADO_TOTAL carregados: ${dadosExecutado.length} registros`);
                } else {
                    console.warn('Aba EXECUTADO_TOTAL não encontrada na planilha');
                }
                
                if (workbook.SheetNames.includes('PLANEJADO_TOTAL')) {
                    const sheet = workbook.Sheets['PLANEJADO_TOTAL'];
                    dadosPlanejado = XLSX.utils.sheet_to_json(sheet);
                    console.log(`Dados da aba PLANEJADO_TOTAL carregados: ${dadosPlanejado.length} registros`);
                } else {
                    console.warn('Aba PLANEJADO_TOTAL não encontrada na planilha');
                }
                
                // Verificar se pelo menos uma das abas foi encontrada
                if (dadosExecutado.length === 0 && dadosPlanejado.length === 0) {
                    throw new Error('Nenhum dado encontrado nas abas EXECUTADO_TOTAL ou PLANEJADO_TOTAL. Verifique o formato da planilha.');
                }
                
                // Limpar os campos com undefined ou null nos dados executados
                dadosExecutado = dadosExecutado.map(item => {
                    const newItem = {};
                    Object.keys(item).forEach(key => {
                        newItem[key] = item[key] === undefined || item[key] === null ? '' : item[key];
                    });
                    return newItem;
                });
                
                // Limpar os campos com undefined ou null nos dados planejados
                dadosPlanejado = dadosPlanejado.map(item => {
                    const newItem = {};
                    Object.keys(item).forEach(key => {
                        newItem[key] = item[key] === undefined || item[key] === null ? '' : item[key];
                    });
                    return newItem;
                });
                
                console.log('Dados carregados com sucesso:', {
                    executado: dadosExecutado.length,
                    planejado: dadosPlanejado.length
                });
                
                // Inicializar filtros e gráficos
                inicializarFiltros();
                inicializarTabelaExecutado();
                inicializarTabelaPlanejado();
                atualizarDashboard();
                
                return true;
            } catch (error) {
                console.error('Erro ao processar a planilha:', error);
                alert('Erro ao processar a planilha: ' + error.message);
                
                // Exibir mensagem de erro no dashboard
                document.getElementById('progressoAcoes').innerHTML = 
                    '<div class="alert alert-danger p-4">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>' +
                    '<strong>Erro ao processar a planilha:</strong> ' + error.message +
                    '</div>';
                
                return false;
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Função para inicializar os filtros
        function inicializarFiltros() {
            // Limpar os filtros atuais
            document.getElementById('filtroAno').innerHTML = '<option value="todos">Todos os Anos</option>';
            document.getElementById('filtroAcao').innerHTML = '<option value="todos">Todas as Ações</option>';
            document.getElementById('filtroNatureza').innerHTML = '<option value="todos">Todas as Naturezas</option>';
            document.getElementById('filtroFundo').innerHTML = '<option value="todos">Todos os Fundos</option>';
            
            // Obter valores únicos para cada filtro
            const anos = new Set();
            const acoes = new Set();
            const naturezas = new Set();
            const fundos = new Set();
            
            // Adicionar valores dos dados executados
            dadosExecutado.forEach(item => {
                if (item['ANO\r\nREPASSE']) anos.add(item['ANO\r\nREPASSE']);
                if (item['AÇÃO']) acoes.add(item['AÇÃO']);
                if (item['NATUREZA\r\nDESPESA']) naturezas.add(item['NATUREZA\r\nDESPESA']);
                if (item['FUNDO']) fundos.add(item['FUNDO']);
            });
            
            // Adicionar valores dos dados planejados
            dadosPlanejado.forEach(item => {
                if (item['ANO\r\nREPASSE']) anos.add(item['ANO\r\nREPASSE']);
                if (item['AÇÃO']) acoes.add(item['AÇÃO']);
                if (item['NATUREZA\r\nDESPESA']) naturezas.add(item['NATUREZA\r\nDESPESA']);
                if (item['FUNDO']) fundos.add(item['FUNDO']);
            });
            
            // Preencher os select de filtros
            [...anos].sort().forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                document.getElementById('filtroAno').appendChild(option);
            });
            
            [...acoes].sort().forEach(acao => {
                const option = document.createElement('option');
                option.value = acao;
                option.textContent = acao;
                document.getElementById('filtroAcao').appendChild(option);
            });
            
            [...naturezas].sort().forEach(natureza => {
                const option = document.createElement('option');
                option.value = natureza;
                option.textContent = natureza;
                document.getElementById('filtroNatureza').appendChild(option);
            });
            
            [...fundos].sort().forEach(fundo => {
                const option = document.createElement('option');
                option.value = fundo;
                option.textContent = fundo;
                document.getElementById('filtroFundo').appendChild(option);
            });
            
            // Adicionar eventos de change para os filtros
            document.getElementById('filtroAno').addEventListener('change', function() {
                filtrosAplicados.ano = this.value;
                atualizarDashboard();
            });
            
            document.getElementById('filtroAcao').addEventListener('change', function() {
                filtrosAplicados.acao = this.value;
                atualizarDashboard();
            });
            
            document.getElementById('filtroNatureza').addEventListener('change', function() {
                filtrosAplicados.natureza = this.value;
                atualizarDashboard();
            });
            
            document.getElementById('filtroFundo').addEventListener('change', function() {
                filtrosAplicados.fundo = this.value;
                atualizarDashboard();
            });
        }

        // Função para aplicar filtros aos dados
        function filtrarDados(dados) {
            return dados.filter(item => {
                // Verificar cada filtro aplicado
                if (filtrosAplicados.ano !== 'todos' && item['ANO\r\nREPASSE'] != filtrosAplicados.ano) {
                    return false;
                }
                
                if (filtrosAplicados.acao !== 'todos' && item['AÇÃO'] !== filtrosAplicados.acao) {
                    return false;
                }
                
                if (filtrosAplicados.natureza !== 'todos' && item['NATUREZA\r\nDESPESA'] !== filtrosAplicados.natureza) {
                    return false;
                }
                
                if (filtrosAplicados.fundo !== 'todos' && item['FUNDO'] !== filtrosAplicados.fundo) {
                    return false;
                }
                
                return true;
            });
        }

        // Função para calcular os totais de execução
        function calcularTotais() {
            const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
            const dadosPlanejadoFiltrados = filtrarDados(dadosPlanejado);
            
            // Calcular o total executado
            const totalExecutado = dadosExecutadoFiltrados.reduce((acc, item) => {
                return acc + (parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0);
            }, 0);
            
            // Calcular o total planejado
            const totalPlanejado = dadosPlanejadoFiltrados.reduce((acc, item) => {
                return acc + (parseFloat(item['VALOR ESTIMADO'] || 0) || 0);
            }, 0);
            
            // Calcular o percentual de execução
            const percentualExecucao = totalPlanejado > 0 ? (totalExecutado / totalPlanejado) * 100 : 0;
            
            // Calcular o saldo a executar
            const saldoExecutar = totalPlanejado - totalExecutado;
            
            return {
                totalExecutado,
                totalPlanejado,
                percentualExecucao,
                saldoExecutar
            };
        }

        // Função para atualizar os cards de resumo
        function atualizarCardsResumo() {
            const totais = calcularTotais();
            
            document.getElementById('totalExecutado').textContent = formatarMoeda(totais.totalExecutado);
            document.getElementById('totalPlanejado').textContent = formatarMoeda(totais.totalPlanejado);
            document.getElementById('percentualExecucao').textContent = totais.percentualExecucao.toFixed(2) + '%';
            
            const saldoElem = document.getElementById('saldoExecutar');
            saldoElem.textContent = formatarMoeda(Math.abs(totais.saldoExecutar));
            
            if (totais.saldoExecutar > 0) {
                saldoElem.className = 'value-card negative';
            } else if (totais.saldoExecutar < 0) {
                saldoElem.className = 'value-card positive';
            } else {
                saldoElem.className = 'value-card neutral';
            }
        }

        // Função segura para obter contexto de gráfico
        function getChartContext(chartId) {
            const canvas = document.getElementById(chartId);
            if (!canvas) {
                console.error(`Canvas não encontrado para o gráfico ${chartId}`);
                return null;
            }
            
            return canvas.getContext('2d');
        }

        // Função para limpar e preparar um gráfico
        function prepareChart(chartId) {
            // Destruir o gráfico anterior se existir
            if (charts[chartId] && typeof charts[chartId].destroy === 'function') {
                charts[chartId].destroy();
                charts[chartId] = null;
            }
            
            return getChartContext(chartId);
        }

        // Função para criar/atualizar o gráfico de comparativo por ano
        function atualizarGraficoComparativoAno() {
            try {
                const ctx = prepareChart('comparativoAnoChart');
                if (!ctx) return;
                
                const anos = new Set();
                
                // Coletar todos os anos únicos
                dadosExecutado.forEach(item => {
                    if (item['ANO\r\nREPASSE']) anos.add(item['ANO\r\nREPASSE']);
                });
                
                dadosPlanejado.forEach(item => {
                    if (item['ANO\r\nREPASSE']) anos.add(item['ANO\r\nREPASSE']);
                });
                
                const anosOrdenados = [...anos].sort();
                
                // Calcular totais por ano
                const dadosExecutadoPorAno = anosOrdenados.map(ano => {
                    const total = dadosExecutado
                        .filter(item => {
                            return item['ANO\r\nREPASSE'] == ano && 
                                (filtrosAplicados.acao === 'todos' || item['AÇÃO'] === filtrosAplicados.acao) &&
                                (filtrosAplicados.natureza === 'todos' || item['NATUREZA\r\nDESPESA'] === filtrosAplicados.natureza) &&
                                (filtrosAplicados.fundo === 'todos' || item['FUNDO'] === filtrosAplicados.fundo);
                        })
                        .reduce((acc, item) => acc + (parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0), 0);
                    
                    return total;
                });
                
                const dadosPlanejadoPorAno = anosOrdenados.map(ano => {
                    const total = dadosPlanejado
                        .filter(item => {
                            return item['ANO\r\nREPASSE'] == ano && 
                                (filtrosAplicados.acao === 'todos' || item['AÇÃO'] === filtrosAplicados.acao) &&
                                (filtrosAplicados.natureza === 'todos' || item['NATUREZA\r\nDESPESA'] === filtrosAplicados.natureza) &&
                                (filtrosAplicados.fundo === 'todos' || item['FUNDO'] === filtrosAplicados.fundo);
                        })
                        .reduce((acc, item) => acc + (parseFloat(item['VALOR ESTIMADO'] || 0) || 0), 0);
                    
                    return total;
                });
                
                // Criar/atualizar o gráfico
                charts['comparativoAnoChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: anosOrdenados,
                        datasets: [
                            {
                                label: 'Planejado',
                                data: dadosPlanejadoPorAno,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Executado',
                                data: dadosExecutadoPorAno,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatarMoeda(value).replace('R$', '');
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatarMoeda(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao atualizar gráfico comparativo por ano:', error);
            }
        }

        // Função para criar/atualizar o gráfico de natureza de despesa
        function atualizarGraficoNaturezaDespesa() {
            try {
                const ctx = prepareChart('naturezaDespesaChart');
                if (!ctx) return;
                
                const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
                const naturezas = {};
                
                // Agrupar por natureza de despesa
                dadosExecutadoFiltrados.forEach(item => {
                    const natureza = item['NATUREZA\r\nDESPESA'] || 'Não especificado';
                    const valor = parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                    
                    if (!naturezas[natureza]) {
                        naturezas[natureza] = 0;
                    }
                    
                    naturezas[natureza] += valor;
                });
                
                // Preparar dados para o gráfico
                const labels = Object.keys(naturezas);
                const valores = Object.values(naturezas);
                
                // Criar/atualizar o gráfico
                charts['naturezaDespesaChart'] = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: valores,
                            backgroundColor: coresPrimarias.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentual = Math.round((context.raw / total) * 100);
                                        return context.label + ': ' + formatarMoeda(context.raw) + ' (' + percentual + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao atualizar gráfico de natureza de despesa:', error);
            }
        }

        // Função para criar/atualizar o gráfico de execução mensal
        function atualizarGraficoExecucaoMensal() {
            try {
                const ctx = prepareChart('execucaoMensalChart');
                if (!ctx) return;
                
                const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
                const execucaoPorMes = {};
                
                // Agrupar por mês de execução
                dadosExecutadoFiltrados.forEach(item => {
                    if (!item['DATA\r\nPAG. BANCÁRIO']) return;
                    
                    try {
                        const data = new Date(item['DATA\r\nPAG. BANCÁRIO']);
                        const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                        const valor = parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                        
                        if (!execucaoPorMes[mesAno]) {
                            execucaoPorMes[mesAno] = 0;
                        }
                        
                        execucaoPorMes[mesAno] += valor;
                    } catch (e) {
                        console.warn('Erro ao processar data:', item['DATA\r\nPAG. BANCÁRIO'], e);
                    }
                });
                
                // Ordenar por mês/ano
                const mesesOrdenados = Object.keys(execucaoPorMes).sort();
                const valoresOrdenados = mesesOrdenados.map(mes => execucaoPorMes[mes]);
                
                // Formatar rótulos de mês/ano
                const labelsFormatados = mesesOrdenados.map(mesAno => {
                    const [ano, mes] = mesAno.split('-');
                    return `${mes}/${ano}`;
                });
                
                // Criar/atualizar o gráfico
                charts['execucaoMensalChart'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labelsFormatados,
                        datasets: [{
                            label: 'Valor Executado',
                            data: valoresOrdenados,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatarMoeda(value).replace('R$', '');
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Valor: ' + formatarMoeda(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao atualizar gráfico de execução mensal:', error);
            }
        }

        // Função para criar/atualizar o gráfico de itens macro
        function atualizarGraficoItensMacro() {
            try {
                const ctx = prepareChart('itensMacroChart');
                if (!ctx) return;
                
                const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
                const itensMacro = {};
                
                // Agrupar por item macro
                dadosExecutadoFiltrados.forEach(item => {
                    const itemMacro = item['ITENS MACRO'] || 'Não especificado';
                    const valor = parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                    
                    if (!itensMacro[itemMacro]) {
                        itensMacro[itemMacro] = 0;
                    }
                    
                    itensMacro[itemMacro] += valor;
                });
                
                // Preparar dados para o gráfico
                const labels = Object.keys(itensMacro);
                const valores = Object.values(itensMacro);
                
                // Criar/atualizar o gráfico
                charts['itensMacroChart'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: valores,
                            backgroundColor: coresPrimarias.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentual = Math.round((context.raw / total) * 100);
                                        return context.label + ': ' + formatarMoeda(context.raw) + ' (' + percentual + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao atualizar gráfico de itens macro:', error);
            }
        }

        // Função para atualizar o progresso de execução por ação
        function atualizarProgressoAcoes() {
            try {
                const acoes = {};
                
                // Coletar todas as ações únicas
                dadosExecutado.forEach(item => {
                    if (item['AÇÃO']) acoes[item['AÇÃO']] = { executado: 0, planejado: 0 };
                });
                
                dadosPlanejado.forEach(item => {
                    if (item['AÇÃO']) acoes[item['AÇÃO']] = acoes[item['AÇÃO']] || { executado: 0, planejado: 0 };
                });
                
                // Calcular totais por ação
                const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
                const dadosPlanejadoFiltrados = filtrarDados(dadosPlanejado);
                
                dadosExecutadoFiltrados.forEach(item => {
                    if (!item['AÇÃO']) return;
                    
                    acoes[item['AÇÃO']].executado += parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                });
                
                dadosPlanejadoFiltrados.forEach(item => {
                    if (!item['AÇÃO']) return;
                    
                    acoes[item['AÇÃO']].planejado += parseFloat(item['VALOR ESTIMADO'] || 0) || 0;
                });
                
                // Construir as barras de progresso
                const container = document.getElementById('progressoAcoes');
                container.innerHTML = '';
                
                Object.keys(acoes).sort().forEach(acao => {
                    const executado = acoes[acao].executado;
                    const planejado = acoes[acao].planejado;
                    
                    if (planejado === 0) return; // Pular ações sem planejamento
                    
                    const percentual = Math.min(100, (executado / planejado) * 100);
                    const row = document.createElement('div');
                    row.className = 'mb-3';
                    
                    const labelRow = document.createElement('div');
                    labelRow.className = 'd-flex justify-content-between mb-1';
                    
                    const acaoLabel = document.createElement('span');
                    acaoLabel.className = 'fw-bold';
                    acaoLabel.textContent = acao;
                    
                    const valoresLabel = document.createElement('span');
                    valoresLabel.innerHTML = `${formatarMoeda(executado)} / ${formatarMoeda(planejado)} (${percentual.toFixed(1)}%)`;
                    
                    labelRow.appendChild(acaoLabel);
                    labelRow.appendChild(valoresLabel);
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${percentual}%`;
                    progressBar.style.backgroundColor = percentual >= 90 ? '#28a745' : 
                                                        percentual >= 70 ? '#17a2b8' : 
                                                        percentual >= 50 ? '#ffc107' : '#dc3545';
                    
                    progressContainer.appendChild(progressBar);
                    
                    row.appendChild(labelRow);
                    row.appendChild(progressContainer);
                    
                    container.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao atualizar progresso por ação:', error);
                document.getElementById('progressoAcoes').innerHTML = 
                    '<div class="alert alert-danger p-3">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>' +
                    'Erro ao gerar o progresso por ação: ' + error.message +
                    '</div>';
            }
        }

        // Função para inicializar a tabela de dados executados
        function inicializarTabelaExecutado() {
            try {
                // Verificar se o elemento da tabela existe
                const tabelaElement = document.getElementById("tabelaExecutado");
                if (!tabelaElement) {
                    console.error("Elemento da tabela de executados não encontrado");
                    return;
                }
                
                // Limpar qualquer instância anterior para evitar duplicação
                if (tabelaExecutado) {
                    try {
                        tabelaExecutado.destroy();
                    } catch (e) {
                        console.warn("Erro ao destruir tabela anterior:", e);
                    }
                }
                
                // Criar uma nova configuração de tabela
                const tabelaConfig = {
                    height: 500,
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 10,
                    paginationSizeSelector: [10, 20, 50, 100],
                    movableColumns: true,
                    placeholder: "Nenhum dado disponível",
                    columns: [
                        { title: "Ano", field: "ANO\r\nREPASSE", headerFilter: true, sorter: "number" },
                        { title: "Ação", field: "AÇÃO", headerFilter: true },
                        { title: "Natureza", field: "NATUREZA\r\nDESPESA", headerFilter: true },
                        { title: "Processo", field: "N°\r\nPROCESSO\r\nCOMPRA ESTADUAL", headerFilter: true },
                        { title: "Licitação", field: "TIPO\r\nLICITAÇÃO", headerFilter: true },
                        { title: "Órgão", field: "ÓRGÃO CONTRATANTE", headerFilter: true },
                        { title: "Fornecedor", field: "NOME FORNECEDOR", headerFilter: true },
                        { 
                            title: "Data Empenho", 
                            field: "DATA EMPENHO", 
                            sorter: "date", 
                            formatter: function(cell) {
                                return formatarData(cell.getValue());
                            } 
                        },
                        { 
                            title: "Valor Empenho", 
                            field: "VALOR EMPENHO", 
                            sorter: "number", 
                            formatter: function(cell) {
                                return formatarMoeda(cell.getValue());
                            } 
                        },
                        { 
                            title: "Data Pagamento", 
                            field: "DATA\r\nPAG. BANCÁRIO", 
                            sorter: "date", 
                            formatter: function(cell) {
                                return formatarData(cell.getValue());
                            } 
                        },
                        { 
                            title: "Valor Pago", 
                            field: "VALOR\r\nPAG. BANCÁRIO", 
                            sorter: "number", 
                            formatter: function(cell) {
                                return formatarMoeda(cell.getValue());
                            } 
                        },
                        { title: "Bem/Serviço", field: "BEM / SEVIÇO ADQUIRIDO", headerFilter: true },
                        { title: "Item Macro", field: "ITENS MACRO", headerFilter: true }
                    ]
                };
                
                // Inicializar tabela com configuração básica primeiro
                tabelaExecutado = new Tabulator("#tabelaExecutado", tabelaConfig);
                
                // Após a tabela estar inicializada, carregar os dados
                tabelaExecutado.on("tableBuilt", function() {
                    try {
                        const dadosFiltrados = filtrarDados(dadosExecutado);
                        tabelaExecutado.setData(dadosFiltrados);
                        console.log("Tabela de dados executados inicializada com " + dadosFiltrados.length + " registros");
                    } catch (e) {
                        console.error("Erro ao definir dados na tabela de executados:", e);
                    }
                });
                
                // Exportar para Excel
                document.getElementById('btnExportarExecucao').addEventListener('click', function() {
                    if (tabelaExecutado && typeof tabelaExecutado.download === 'function') {
                        tabelaExecutado.download("xlsx", "dados_executados.xlsx", {sheetName:"Executado"});
                    } else {
                        alert("A tabela não está pronta para exportação. Tente novamente em alguns instantes.");
                    }
                });
            } catch (error) {
                console.error('Erro ao inicializar tabela de dados executados:', error);
            }
        }
     
        // Função para inicializar a tabela de dados planejados
        function inicializarTabelaPlanejado() {
            try {
                // Verificar se o elemento da tabela existe
                const tabelaElement = document.getElementById("tabelaPlanejado");
                if (!tabelaElement) {
                    console.error("Elemento da tabela de planejados não encontrado");
                    return;
                }
                
                // Limpar qualquer instância anterior para evitar duplicação
                if (tabelaPlanejado) {
                    try {
                        tabelaPlanejado.destroy();
                    } catch (e) {
                        console.warn("Erro ao destruir tabela anterior:", e);
                    }
                }
                
                // Criar uma nova configuração de tabela
                const tabelaConfig = {
                    height: 500,
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 10,
                    paginationSizeSelector: [10, 20, 50, 100],
                    movableColumns: true,
                    placeholder: "Nenhum dado disponível",
                    columns: [
                        { title: "Ano", field: "ANO\r\nREPASSE", headerFilter: true, sorter: "number" },
                        { title: "Ação", field: "AÇÃO", headerFilter: true },
                        { title: "Natureza", field: "NATUREZA\r\nDESPESA", headerFilter: true },
                        { title: "Bem/Serviço Pretendido", field: "BEM / SEVIÇO PRETENDIDOS", headerFilter: true },
                        { 
                            title: "Valor Estimado", 
                            field: "VALOR ESTIMADO", 
                            sorter: "number", 
                            formatter: function(cell) {
                                return formatarMoeda(cell.getValue());
                            } 
                        },
                        { title: "Processo Interno", field: "N° \r\nPROCESSO INTERNO", headerFilter: true },
                        { 
                            title: "Previsão Execução", 
                            field: "DATA EXECUÇÃO\r\nPrevisão de Execução\r\n(mês/ano)", 
                            sorter: "date", 
                            formatter: function(cell) {
                                return formatarData(cell.getValue());
                            } 
                        },
                        { title: "Fundo", field: "FUNDO", headerFilter: true },
                        { title: "Subtipo Fundo", field: "SUBTIPO DO FUNDO", headerFilter: true }
                    ]
                };
                
                // Inicializar tabela com configuração básica primeiro
                tabelaPlanejado = new Tabulator("#tabelaPlanejado", tabelaConfig);
                
                // Após a tabela estar inicializada, carregar os dados
                tabelaPlanejado.on("tableBuilt", function() {
                    try {
                        const dadosFiltrados = filtrarDados(dadosPlanejado);
                        tabelaPlanejado.setData(dadosFiltrados);
                        console.log("Tabela de dados planejados inicializada com " + dadosFiltrados.length + " registros");
                    } catch (e) {
                        console.error("Erro ao definir dados na tabela de planejados:", e);
                    }
                });
                
                // Exportar para Excel
                document.getElementById('btnExportarPlanejamento').addEventListener('click', function() {
                    if (tabelaPlanejado && typeof tabelaPlanejado.download === 'function') {
                        tabelaPlanejado.download("xlsx", "dados_planejados.xlsx", {sheetName:"Planejado"});
                    } else {
                        alert("A tabela não está pronta para exportação. Tente novamente em alguns instantes.");
                    }
                });
            } catch (error) {
                console.error('Erro ao inicializar tabela de dados planejados:', error);
            }
        }
        
        // Função para atualizar os gráficos da aba de análise financeira
        function atualizarGraficosAnaliseFinanceira() {
            try {
                // Gráfico de eficiência na execução
                const totais = calcularTotais();
                
                const ctxEficiencia = prepareChart('eficienciaChart');
                if (ctxEficiencia) {
                    registrarGaugeChart();
                    
                    charts['eficienciaChart'] = new Chart(ctxEficiencia, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [totais.percentualExecucao, 100 - totais.percentualExecucao],
                                backgroundColor: [
                                    totais.percentualExecucao >= 90 ? '#28a745' : 
                                    totais.percentualExecucao >= 70 ? '#17a2b8' : 
                                    totais.percentualExecucao >= 50 ? '#ffc107' : '#dc3545',
                                    '#e9ecef'
                                ],
                                borderWidth: 0,
                                cutout: '80%'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Execução: ${totais.percentualExecucao.toFixed(2)}%`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [{
                            beforeDraw: function(chart) {
                                const width = chart.width;
                                const height = chart.height;
                                const ctx = chart.ctx;
                                
                                ctx.restore();
                                
                                // Desenhar a percentagem no centro
                                ctx.font = 'bold 24px Arial';
                                ctx.textBaseline = 'middle';
                                ctx.textAlign = 'center';
                                ctx.fillStyle = '#333';
                                ctx.fillText(`${totais.percentualExecucao.toFixed(2)}%`, width / 2, height / 2);
                                
                                // Texto menor abaixo
                                ctx.font = '14px Arial';
                                ctx.fillText('Execução', width / 2, height / 2 + 25);
                                
                                ctx.save();
                            }
                        }]
                    });
                }
                
                // Análise textual financeira
                const containerAnalise = document.getElementById('analiseFinanceira');
                containerAnalise.innerHTML = '';
                
                const card = document.createElement('div');
                card.className = 'bg-light p-3 rounded';
                
                // Adicionar conteúdo da análise
                let conteudoAnalise = `
                    <h5 class="mb-3">Síntese da Execução Orçamentária</h5>
                    <p><strong>Total Planejado:</strong> ${formatarMoeda(totais.totalPlanejado)}</p>
                    <p><strong>Total Executado:</strong> ${formatarMoeda(totais.totalExecutado)}</p>
                    <p><strong>Percentual de Execução:</strong> ${totais.percentualExecucao.toFixed(2)}%</p>
                    <p><strong>Saldo a Executar:</strong> ${formatarMoeda(Math.abs(totais.saldoExecutar))}</p>
                    <hr>
                    <h6>Análise de Eficiência:</h6>
                `;
                
                if (totais.percentualExecucao >= 90) {
                    conteudoAnalise += `<p class="text-success">Excelente execução orçamentária, com taxa de execução acima de 90%.</p>`;
                } else if (totais.percentualExecucao >= 70) {
                    conteudoAnalise += `<p class="text-info">Boa execução orçamentária, com taxa de execução entre 70% e 90%.</p>`;
                } else if (totais.percentualExecucao >= 50) {
                    conteudoAnalise += `<p class="text-warning">Execução orçamentária moderada, com taxa de execução entre 50% e 70%.</p>`;
                } else {
                    conteudoAnalise += `<p class="text-danger">Baixa execução orçamentária, com taxa de execução abaixo de 50%.</p>`;
                }
                
                card.innerHTML = conteudoAnalise;
                containerAnalise.appendChild(card);
                
                // Comparativo entre ações
                const dadosExecutadoFiltrados = filtrarDados(dadosExecutado);
                const dadosPlanejadoFiltrados = filtrarDados(dadosPlanejado);
                
                // Obter as 5 principais ações em termos de valor
                const acoesValores = {};
                
                dadosExecutadoFiltrados.forEach(item => {
                    if (!item['AÇÃO']) return;
                    
                    if (!acoesValores[item['AÇÃO']]) {
                        acoesValores[item['AÇÃO']] = { executado: 0, planejado: 0 };
                    }
                    
                    acoesValores[item['AÇÃO']].executado += parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                });
                
                dadosPlanejadoFiltrados.forEach(item => {
                    if (!item['AÇÃO']) return;
                    
                    if (!acoesValores[item['AÇÃO']]) {
                        acoesValores[item['AÇÃO']] = { executado: 0, planejado: 0 };
                    }
                    
                    acoesValores[item['AÇÃO']].planejado += parseFloat(item['VALOR ESTIMADO'] || 0) || 0;
                });
                
                // Ordenar ações por valor total (planejado + executado)
                const acoesOrdenadas = Object.keys(acoesValores)
                    .map(acao => ({ acao, total: acoesValores[acao].planejado + acoesValores[acao].executado }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 5)
                    .map(item => item.acao);
                
                const dadosComparativoAcoes = {
                    executado: acoesOrdenadas.map(acao => acoesValores[acao].executado),
                    planejado: acoesOrdenadas.map(acao => acoesValores[acao].planejado)
                };
                
                const ctxComparativoAcoes = prepareChart('comparativoAcoesChart');
                if (ctxComparativoAcoes) {
                    charts['comparativoAcoesChart'] = new Chart(ctxComparativoAcoes, {
                        type: 'bar',
                        data: {
                            labels: acoesOrdenadas,
                            datasets: [
                                {
                                    label: 'Planejado',
                                    data: dadosComparativoAcoes.planejado,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Executado',
                                    data: dadosComparativoAcoes.executado,
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatarMoeda(value).replace('R$', '');
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + formatarMoeda(context.raw);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Tendência de execução
                const execucaoPorMes = {};
                
                // Agrupar por mês de execução
                dadosExecutadoFiltrados.forEach(item => {
                    if (!item['DATA\r\nPAG. BANCÁRIO']) return;
                    
                    try {
                        const data = new Date(item['DATA\r\nPAG. BANCÁRIO']);
                        const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                        const valor = parseFloat(item['VALOR\r\nPAG. BANCÁRIO'] || 0) || 0;
                        
                        if (!execucaoPorMes[mesAno]) {
                            execucaoPorMes[mesAno] = 0;
                        }
                        
                        execucaoPorMes[mesAno] += valor;
                    } catch (e) {
                        console.warn('Erro ao processar data para tendência:', e);
                    }
                });
                
                // Ordenar por mês/ano
                const mesesOrdenados = Object.keys(execucaoPorMes).sort();
                const valoresOrdenados = mesesOrdenados.map(mes => execucaoPorMes[mes]);
                
                // Calcular média móvel (3 meses)
                const mediasMoveis = [];
                
                for (let i = 0; i < valoresOrdenados.length; i++) {
                    if (i < 2) {
                        mediasMoveis.push(null);
                    } else {
                        const media = (valoresOrdenados[i] + valoresOrdenados[i - 1] + valoresOrdenados[i - 2]) / 3;
                        mediasMoveis.push(media);
                    }
                }
                
                // Formatar rótulos de mês/ano
                const labelsFormatados = mesesOrdenados.map(mesAno => {
                    const [ano, mes] = mesAno.split('-');
                    return `${mes}/${ano}`;
                });
                
                // Criar/atualizar o gráfico
                const ctxTendencia = prepareChart('tendenciaExecucaoChart');
                if (ctxTendencia) {
                    charts['tendenciaExecucaoChart'] = new Chart(ctxTendencia, {
                        type: 'line',
                        data: {
                            labels: labelsFormatados,
                            datasets: [
                                {
                                    label: 'Valor Executado',
                                    data: valoresOrdenados,
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 2,
                                    tension: 0
                                },
                                {
                                    label: 'Média Móvel (3 meses)',
                                    data: mediasMoveis,
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatarMoeda(value).replace('R$', '');
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + formatarMoeda(context.raw);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao atualizar gráficos de análise financeira:', error);
            }
        }
        
        // Função para atualizar todas as visualizações do dashboard
        function atualizarDashboard() {
            try {
                // Atualizar cards de resumo
                atualizarCardsResumo();
                
                // Atualizar progresso por ação
                atualizarProgressoAcoes();
                
                // Atualizar gráficos da aba de gráficos
                atualizarGraficoComparativoAno();
                atualizarGraficoNaturezaDespesa();
                atualizarGraficoExecucaoMensal();
                atualizarGraficoItensMacro();
                
                // Atualizar tabelas - de forma segura
                setTimeout(() => {
                    try {
                        if (tabelaExecutado && typeof tabelaExecutado.setData === 'function') {
                            tabelaExecutado.setData(filtrarDados(dadosExecutado));
                        }
                        
                        if (tabelaPlanejado && typeof tabelaPlanejado.setData === 'function') {
                            tabelaPlanejado.setData(filtrarDados(dadosPlanejado));
                        }
                    } catch (tableError) {
                        console.error('Erro ao atualizar tabelas:', tableError);
                    }
                }, 100); // Pequeno atraso para garantir que as tabelas estejam prontas
                
                // Atualizar análise financeira
                atualizarGraficosAnaliseFinanceira();
                
                console.log('Dashboard atualizado com sucesso');
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
                alert('Ocorreu um erro ao atualizar o dashboard: ' + error.message);
            }
        }

        // Função para registrar o gráfico tipo gauge
        function registrarGaugeChart() {
            // Verificamos se já registrou para evitar redefinir
            if (!Chart.controllers.gauge) {
                Chart.register({
                    id: 'gauge',
                    defaults: {},
                    beforeInit: function(chart) {}
                });
            }
        }

        // Função para carregar os dados do arquivo Excel
        async function carregarDadosExcel(arquivo) {
            document.getElementById('loader').style.display = 'flex';
            
            try {
                console.log('Carregando arquivo Excel:', arquivo.name);
                const sucesso = await carregarPlanilha(arquivo);
                
                if (sucesso) {
                    console.log('Dados carregados com sucesso:', {
                        executado: dadosExecutado.length + ' registros',
                        planejado: dadosPlanejado.length + ' registros'
                    });
                }
                
                return sucesso;
            } catch (error) {
                console.error('Erro ao carregar dados do Excel:', error);
                alert('Ocorreu um erro ao processar a planilha: ' + error.message);
                
                // Exibir mensagem de erro no dashboard
                document.getElementById('progressoAcoes').innerHTML = 
                    '<div class="alert alert-danger p-4">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>' +
                    '<strong>Erro ao processar a planilha:</strong> ' + error.message +
                    '<br>Verifique o formato do arquivo e tente novamente.' +
                    '</div>';
                
                return false;
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Inicialização da página
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando dashboard...');
            
            // Esconder o loader quando a página carrega
            document.getElementById('loader').style.display = 'none';
            
            // Configurar estado inicial do dashboard
            document.getElementById('totalExecutado').textContent = 'R$ 0,00';
            document.getElementById('totalPlanejado').textContent = 'R$ 0,00';
            document.getElementById('percentualExecucao').textContent = '0%';
            document.getElementById('saldoExecutar').textContent = 'R$ 0,00';
            
            // Mostrar mensagem instruindo o usuário
            document.getElementById('progressoAcoes').innerHTML = 
                '<div class="alert alert-info text-center p-4">' +
                '<i class="fas fa-info-circle me-2 fs-4"></i>' +
                '<strong>Clique no botão "Importar Planilha" acima para carregar os dados da sua planilha XLSX</strong><br>' +
                'A planilha deve conter as abas "EXECUTADO_TOTAL" e "PLANEJADO_TOTAL"' +
                '</div>';
            
            // Configurar evento do botão de importar
            document.getElementById('btnImportExcel').addEventListener('click', function() {
                const inputFile = document.createElement('input');
                inputFile.type = 'file';
                inputFile.accept = '.xlsx,.xls';
                
                inputFile.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const arquivo = e.target.files[0];
                        carregarDadosExcel(arquivo);
                    }
                });
                
                inputFile.click();
            });
            
            console.log('Dashboard inicializado e pronto para uso');
        });
    </script>
</body>
</html>